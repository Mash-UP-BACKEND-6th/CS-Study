# 시스템을 연결하는 네트워크 구조

## 1. 네트워크

네트워크는 시스템 내에서 빠질 수 없는 중요한 요소 중 하나이지만 네트워크의 통신 흐름을 구체적으로 도식화하기는 어렵다. 현재 네트워크 자체가 그 구조를 알지 못해도 사용할 수 있도록 해 놓았기 때문이다.

## 2. 계층 구조

#### 2.1 계층 구조의 비유

![회사 부서를 예로 든 계층 구조](./assets/layer.png)

- 영업부나 인사부는 보내고 싶은 문서나 그림을 총무부에 전달한다.
- 총무부는 각 부서에서 받은 것을 봉투에 넣어서 주소를 기입한 후 우편실로 전달한다.
- 우편실은 총무부에서 받은 편지에 우표를 붙여서 발송한다.

#### 2.2 계층 구조는 역할 분담

계층 구조에서는 데이터나 기능 호출 흐름에 따라 계층 간 역할이 나누어진다. 역할이 나누어 져 있기 때문에 각 층은 자신이 담당하는 일만 책임 지며 다른 일은 다른 계층이 책임을 진다. 상호 연결 되어 있는 계층에서는 교환 방법인 인터페이스만 정해두면 된다.

**계층 구조의 장점**

- 계층 간에 서로 영향을 주지 않고 독립적으로 동작할 수 있다.
- 상호 간에 내부 처리를 은폐하고 있기 때문에 인터페이스만 바꾸지 않으면 각 계층이 내부적인 처리를 마음대로 바꾸어도 문제 없다.

**계층 구조의 단점**

- 오버헤드가 증가하여 작업의 효율성이 떨어진다.

#### 2.3 OSI 7계층 모델

OSI 7계층 모델이란 이전에 OSI라는 통신 규격을 만들 때 고안된 것으로 OSI 통신 기능을 7개의 계층으로 나눈 것이다.

- 어플리케이션 계층(application layer) : 사용자가 실제로 체감할 수 있는 서비스를 제공한다.

- 프레젠테이션 계층(presentation layer) : 데이터 표현 방법을 정의한다.
- 세션 계층(session layer) : 통신 시작과 종료 순서를 지정한다.
- 트랜스포트 계층(transport layer) : 어플리케이션 계층의 프로그램에서 전달 받은 데이터를 목적지 어플리케이션 계층의 프로그램까지 전달하는 역할을 담당한다.
- 네트워크 계층(network layer) : 데이터에 어드레스 정보를 덧붙여 목적지까지 무사히 전달하는 역할을 담당한다.
- 데이터 링크 계층(data link layer) : 유선 LAN 어댑터나 무선 LAN 어댑터가 처리할 수 있는 형태로 데이터를 변환하고 이 데이터를 목적지까지 전달한다.
- 물리 계층(physical layer) : 전기적인 접속

계층 구조는 네트워크 이외에도 존재한다. 어플리케이션, OS, 하드웨어의 조합도 계층 구조라 말할 수 있다. 



## 3. 프로토콜

#### 3.1 프로토콜이란

프로토콜이란 컴퓨터가 서로 통신하기 위해 정한 절차나 규약을 말한다. 

- 예) 비즈니스 미팅 시 사람들은 만나면 먼저 명함을 교환하고 요구사항을 전달한 후 이를 충족 시키기 위한 예산과 납기를 상의하는 협의 과정을 거친다.
- 예) 나는 음성을 사용하고 상대방은 깃발 신호를 사용하여 통신을 할 경우 서로 의사소통이 되지 않는다.

#### 3.2 프로토콜이 필요한 이유

프로토콜은 통신 과정의 절차나 규칙이 기술된 사양서에 불과하다. 그래서 프로토콜 자체는 프로그램처럼 통신 기능을 구현하고 있다거나 통신 장비처럼 눈에 보이는 물리적 형태가 있는 것은 아니다. 다만 프로토콜에 맞추어진 프로그램이나 통신 장비 데이터 포맷 등이 존재하고 이들이 서로 약속된 방식으로 잘 동작해 줄 때 원할한 통신이 가능해진다.

#### 3.3 서버 내부에서의 프로토콜

TCP/IP 이외에도 어떤 장비라도 서로 통신을 하기 위해서는 프로토콜이 필요하다.

**프로토콜의 예**

- USB
- 서버 저장소 (SCSI 프로토콜)
- CPU



## 4. TCP/IP

TCP/IP는 하나의 프로토콜을 지칭하는 말이 아니라 인터넷에서 사용하는 각종 표준 프로토콜을 한대 모아 일컫는 말이다.

#### 4.1 인터넷 발전과 TCP/IP 프로토콜

인터넷은 TCP/IP 프로토콜 집합을 사용해서 전 세계의 네트워크들을 연결하고 통합한 세계 최대의 네트워크이다.

- 인터넷의 영향을 받기 전의 컴퓨터 네트워크 : 컴퓨터의 OS 별로 독자적인 네트워크 프로토콜들이 있어 서로 다른 OS를 사용하는 컴퓨터끼리는 통신을 할 수 없었다.
- 인터넷의 영향을 받은 후의 컴퓨터 네트워크 : 대부분의 컴퓨터 네트워크가 TCP/IP 기반으로 연결되어 있다. 컴퓨터들이 서로 다른 OS를 사용하고 있어도 같은 프로토콜을 지원하고 있다면 통신이 가능하다.



#### 4.2 TCP/IP 계층 구조

TCP/IP에서는 7계층이 분명하게 나누어 지지는 않는다. TCP/IP 4계층 모델 등으로 불리며 OSI 7계층의 1~2계층을 모아서 링크 계층 5~7계층을 모아서 어플리케이션으로 취급하기도 한다.

**TCP/IP 4계층 모델**

- 어플리케이션 계층(application layer) : OSI 7계층의 세션 계층, 표현 계층, 응용 계층에 해당한다.
- 트랜스포트 계층(transport layer) : OSI 7계층의 트랜스포트 계층에 해당한다.
- IP 계층(Internet layer) : OSI 7계층의 네트워크 계층에 해당한다. 
- 링크 계층(link layer) : OSI 7계층의 물리계층과 데이터 링크 계층에 해당한다.

![TCP/IP 4계층 모델 - http 통신 예](./assets/tcp:ip-layer.png)



## 5. 어플리케이션 계층 프로토콜 - HTTP

어플리케이션이 사용하는 프로토콜을 모두 어플리케이션 계층 프로토콜이라 부른다. 어플리케이션 계층은 자신이 통신을 하는 것이 아니라 통신 자체는 모두 OS, 즉 TCP/IP에 맡긴다. 웹 시스템에서 가장 중요한 프로토콜은 HTTP이다.

**HTTP의 처리 흐름**

- 클라이언트 PC에서 브라우저에 URL을 입력한다.
- 요청이 전송된다.
- 웹 서버에서 요청 내용이 해석된다.
- 파일이나 이미지를 응답으로 반환한다.
- 클라이언트 측에서 파일 내부를 해석해서 추가로 `css`나 `jpeg` 등이 포함돼 있으면 다시 요청을 보낸다.

#### 5.1 요청과 응답

통신 과정에서 주고 받은 정보들은 HTTP라 부르고 크게 **요청**과 **응답**의 두가지 형태로 구분된다.

**HTTP 요청에 포함되는 내용**

- 요청 정보 행 : GET/HTTP1.1
- 메세지, 헤더(header) : 브라우저에 대한 상세한 정보가 포함되어 있다.

- 메세지 바디(message body) : 브라우저에 입력한 내용이 포함된다.

**HTTP 응답에 포함되는 내용**

- 상태 정보 행 : HTTP/1.1 200 OK
- 메세지, 헤더(header) : 브라우저에 대한 상세한 정보가 포함되어 있다.

- 메세지 바디(message body) : HTML 데이터가 들어간다.

#### 5.2 어플리케이션 프로토콜 처리

어플리케이션 프로토콜 자체는 통신 구조를 가지지 않지만 원격지에 있는 서버 어플리에이션과 통신할 수 있다. 어플리케이션 계층 프로토콜은 필요한 데이터를 소켓에 기록만하며 통신은 모두 TCP/IP에 위임하기 때문이다. 소켓 이하는 커널 공간에서 처리한다.



## 6. 전송 계층 프로토콜 - TCP

 전송 계층 프로토콜은 어플리케이션 계층과 인터넷 계층 사이에 위치하여 컴퓨터가 받은 데이터를 어플리케이션 까지 전달하는 역할을 하며 신뢰도가 높은 데이터 전송을 가리킨다.

#### 6.1 TCP의 역할

TCP의 역할을 간단히 말하면 '애플리케이션이 보낸 데이터를 그 형태 그대로 상대방한테 전달하는 것이다. 단 주변에는 민페를 끼치지 않는다.'

- TCP의 역할은 서버가 송신할 때와 서버가 수신한 후 애플리케이션에게 전달할 때이며 상대 서버까지 전송하는 부분은 하위 계층은 IP에 모두 위임한다.
- IP만으로도 통신이 가능하지만 IP는 신뢰성이 낮다.

**주요 기능**

- 포트번호를 이용하여 데이터 전송
- 연결 생성
- 데이터 보증과 재전송 제어
- 흐름 제어와 폭주 제어

#### 6.2 TCP 세그먼트

TCP는 데이터 전송에 신뢰성을 더하기 위해 데이터를 세그먼트(segment)라는 단위로 분할하여 관리한다. 

**TCP 세그먼트의 특징**

- TCP 세그먼트는 데이터 본체에 **TCP 헤더**가 붙은 형태로 구성된다.
- 헤더에는 포트번호나 일련 번호와 같은 정보가 포함되어 있다.

![TCP 헤더의 구조](./assets/segment.png)

- MSS(Maximum Transfer Unit) : 하나의 TCP 세그먼트로 전송할 수 있는 최대 데이터 크기
- MSS에 맞게 자동으로 데이터를 분할하는 것도 TCP의 기능이다.

#### 6.3 포트 번호

전송계층에는 인터넷 계층에서 전달한 다양한 종류의 패킷이 들어온다. 이 패킷들은 애플리케이션 계층에 있는 애플리케이션들에게 각각 전달되어야하는데 이때 **포트번호**를 보고 구분한다.

**포트 번호의 범위**

포트번호는 0~65535번까지 사용할 수 있고 웰 노운 포트(well-known-ports), 레지스터드 포트(registered ports), 다이나믹 포트(dynamic ports)의 세종류로 구분된다.

- 웰 노운 포트(well-known-ports) : 0~1023번, 서버 프로그램이 수신 대기할 때 대기하는 포트
- 레지스터드 포트(registered ports) : 1024~49511번, 벤더가 할당받아 사용하는 포트
- 다이나믹 포트(dynamic ports) : 49512~65535번, 클라이언트 프로그램이 사용하는 포트

#### 6.4 연결 생성

TCP는 연결형 프로토콜로, 연결이라 불리는 가상 경로를 생성한다. 커넥션을 맺는 과정을 3단계로 진행된다.

**3방향 핸드셰이크(3-way handshake)**

- 통신 상대인 서버 측에 가상 경로를 열도록 요청한다.
- 서버에서 대기하고 있는 포트 번호로 통신 요구가 오고 서버는 문제가 없으면 열어도 된다는 응답을 한다.
- 클라이언트 측도 확인했다는 메세지를 보내며 이 때 커넥션이 맺어진다.

![3-way handshake](./assets/3-way-handshake.png)

#### 6.5 데이터 보증과 재전송 제어

**데이터 손실 방지 기능**

- 확인 응답(ACK) : 수신 측에 TCP세그먼트가 도착하면 수신 측은 송신 측에 확인응답을 보내 도착했다는 것을 알린다. 송신 측은 ACK이 돌아오는 것을 보고 전송한 세그먼트가 무사히 도착했다는 것을 알 수 있다.
- 재전송 : ACK이 오지 않으면 전송한 TCP 세그먼트가 어떠한 이유로 사라졌다는 것이다. 이 경우에는 데이터를 재전송하여 데이터 손실을 방지한다.

**데이터 순서 보증 구조**

- 일련번호 : 각 TCP 세그먼트에 시퀀스 번호라 하는 숫자를 붙혀 전송한다. 이 일련번호는 TCP 헤더에 기록된다.
- 확인 응답 번호 : 수신한 세그먼트의 일련번호와 수신한 데이터의 바이트 수를 더한 번호이다. 일련번호와 확인 응답 번호 정보를 따로 관리하여 데이터가 제대로 송수신되는지 확인한다.

**재전송 기준**

- 타임 아웃 : 일정 시간 내에 ACK이 돌아오지 않으면 재전송한다.
- 중복 ACK : 중복된 ACK이 3번 돌아 온 경우 재전송한다.
- SACK 옵션 : SACK 옵션을 사용하면 이미 도착한 TCP 세그먼트에 대해서는 도착했다는 것을 정보로 전달할 수 있다. 이를 통해 송신 측은 도착하지 않은 TCP 세그먼트만 선택해서 재전송 할 수 있게 된다.

![3-ACK](./assets/3ack.png)

#### 6.6 흐름 제어와 폭주 제어

데이터를 보내고 ACK을 기다리는 처리를 반복하다 보면 시간이 많이 걸리고 효율성이 떨어진다. TCP에는 어느 정도의 세그먼트 수라면 ACK을 기다리지 않고 전송하는 윈도우라는 개념이 있다. 

**윈도우와 흐름제어**

- 윈도우 크기 : ACK을 기다리지 않고 전송 가능한 데이터 크기이다. 윈도우 크기 범위 내에서는 ACK을 기다리지 않고 전송한다.
- ACK이 오면 해당 세그먼트는 재전송할 필요가 없기 때문에 송신 윈도우를 다음으로 이동한다. 이와 같이 윈도우를 이동해 가는 방식을 슬라이딩 윈도우라 한다.
- 수신측은 더 이상 수신용 소켓 버퍼가 넘쳐서 더 이상 수신이 불가능할 경우 수신 윈도우의 크기를 작게 만들고 이 사실을 송신측에 알린다.
- 기본적으로 수신 측이 폭주 윈도우 크기를 조정하여 폭주 윈도우와 수신 윈도우 중 작은 쪽을 송신 윈도우로 채택하기 때문에 송신 측은 수신 윈도우 크기 이상의 데이터는 ACK 없이 보낼 수 없게 된다. (흐름제어)

![윈도우](./assets/window.png)

**폭주 제어**

- 송신 측 윈도우 크기는 네트워크 폭주 상태에 맞추어 변경 시키기 때문에 폭주 윈도우라 부른다.
- slow start : 폭주 윈도우는 시작 시 1세그먼트에 설정되어 2,4,8세그먼트 식으로 지수 함수적으로 늘려나간다.
- 어느 정도의 크기까지 증가하면 그 이후는 1세그먼트씩 크기를 늘려나간다.
- 세그먼트 전송이 실패하면 폭주 윈도우의 크기를 작게 하여 송신량을 줄인다. 그리고 다시 윈도우의 크기를 크게 만든다. 이와 같은 변화를 반복함으로써 폭주를 제어할 수 있다.



## 7. 네트워크 계층 프로토콜 - IP

네트워크 계층은 데이터 링크 계층과 협력하여 다른 컴퓨터에게 데이터를 전달하는 역할을 한다. IP는 Internet Protocol의 약자로 오늘날 인터넷에서 사용되고 있는 가장 중요한 프로토콜이다.

#### 7.1 IP 역할

IP의 역할을 간단히 말하면 '지정한 대상 서버까지 전달 받은 데이터를 전해 주는 것'이다. 하지만 신뢰성을 보장하지는 않는다.

**주요 기능**

- IP주소를 이용하여 최종 목적지에 데이터 전송
- 라우팅(routing)

#### 7.2 IP 패킷

TCP 세그먼트는 IP 헤더가 추가되어 IP 패킷에 저장된다.

**IP패킷의 수명**

- TTL(Time to live) : IP패킷 헤더에서는 패킷의 생존 기간을 설정할 수 있다. 목적지를 찾지 못해 네트워크 안을 떠돌고 있는 패킷들을 소멸시킬 수 있다.

#### 7.3 IP 주소

IP에서는 최종 목적지 서버까지 여러개의 네트워크를 경유해서 데이터를 전송한다. 이 때 이용 되는 것이 대상 서버를 나타내는 IP주소이다.

**IP주소의 특징**

- IP 주소는 32비트로 표현 된 숫자 집합이다. 사람이 읽기 쉽도록 8비트 단위로 마침표를 찍어 표현한다.
- IP 주소는 네트워크부와 호스트부로 나뉜다. CIDR(사이더) 표기를 이용하거나 서브넷 마스크 표현을 사용하여 구분한다.
  - 네트워크부 : 어떤 네트워크 인지를 가르킨다.
  - 해당 네트워크 내에 있는 컴퓨터(소유자)를 가르킨다.
  - 예) 192.168.0.1/24 - 11000000 10101000 00000000 (네트워크부) 00000001 (호스트부)

- 같은 네트워크 내에 있으면 동일한 네트워크 주소가 사용된다.

#### 7.4 라우팅

인터넷에서 데이터가 목적지까지 제대로 전달되기 위해서는 라우터가 자신과 연결된 다른 라우터를 찾아나가면서 최종 목적지까지 연결되는 경로를 찾아야 한다. 이러한 과정을 라우팅(routing)이라 한다.

**라우터의 역할**

- 라우터의 역할은 네트워크 간의 패킷을 전달하는 것이다.
- 연결하고 있는 각 네트워크에서 사용하는 IP 어드레스가 각각 하나씩 필요하며 결과적으로 연결한 네트워크 개수만큼의 IP어드레스를 여러 개 가지게 된다.

**라우팅 테이블**

- 라우터는 내부에 저장하고 있는 라우팅 테이블이라는 정보를 활용하여 라우팅을 한다.
- 라우팅 테이블에는 목적지 호스트가 속한 네트워크 정보와 그 네트워크로 도달하기 위해 경유해야하는 라우터의 정보가 있다.

![윈도우](./assets/routing.png)

**정적 라우팅과 동적 라우팅**

- 정적 라우팅 : 네트워크 관리자가 직접 수작업으로 라우팅 테이블을 설정하는 방식
- 동적 라우팅 : 라우팅 프로토콜을 사용하여 자동적으로 경로 정보를 수집한 후 라우팅 테이블을 설정하는 방식
- 네트워크 간의 접속 형태가 복잡하면 정적 라우팅으로 설정하는 것이 사실상 불가능 하므로 대부분은 동적라우팅을 사용한다.

**동적 라우팅 알고리즘**

- 거리 벡터형 : RIP 프로토콜이 사용하는 방식으로 목적지까지의 거리를 살펴보고 짧은 경로를 선택하는 방식하다. 이때 거리는 경유하는 라우터의 수를 의미하는 홉의 수로 센다. 비교적 구성이 간단한 LAN 네트워크에 적합하다.

- 링크 상태형 : OSFP 프로토콜이 사용하는 방식으로 네트워크의 통신 상태 정보를 맵으로 관리하면서 상태가 가장 좋은 경로를 선택하는 방식이다. 복잡하고 변화가 잦은 네트워크 구성에 적합하다.

  

## 8. 데이터 링크 계층 프로토콜 - 이더넷

데이터 링크 계층은 네트워크의 하드웨어를 제어하는 부분이다. 이더넷은 동축 케이블이나 UTP 케이블을 사용하는 프로토콜이다.

#### 8.1 이더넷의 역할

이더넷을 포함한 링크 계층 프로토콜의 역할은 간단히 '동일 네트워크 내의 네트워크 장비까지 전달 받은 데이터를 운반하는 것'이다. 이더넷은 동축 케이블 통신에서 사용되기 때문에 전기 신호로 전송된다.

**주요 기능**

- 동일 네트워크 내 데이터 전송

#### 8.2 이더넷 프레임

데이터 링크 계층이 보내는 데이터를 프레임이라 부른다. 이 프레임 안에 송신지와 수신지의 MAC 어드레스 정보가 들어 있다.

**MAC 어드레스**

- IP는 주소를 사용해서 여러 네트워크를 거쳐야 데이터를 전송할 수 있지만 이더넷은 동일 네트워크 내에서만 데이터를 전송할 수 있다. 이때 사용되는 주소가 MAC 주소이다.
- 네트워크 어댑터나 무선 LAN 클라이언트 장비, 무선 AP 장비들은 제조 과정에서 고유한 MAC 주소를 할당받는다.

**프리앰블(preamble)**

- 프레임의 앞부분에 프리앰블이라는 패턴을 두어 신호의 시작을 알 수 있도록 한다.
- 수신 측의 네트워크 어댑터는 전압의 높낮이가 변화하는 신호를 받아 0과 1의 디지털 신호로 복호화 한다. 이때 전압이 변화하는 타이밍에 맞춰 신호를 분석하려면 어디부터가 시작인지 기준점을 알아야한다. 

![이더넷 프레임](./assets/frame.png)

#### 8.3 동일 네트워크 내의 데이터 전송

**IP주소 VS MAC 주소**

- IP주소는 32비트 MAC주소는 48비트이다.
- IP주소는 최종 목적지가 한번 결정되면 전송 과정 중에 변경되지 않지만 MAC주소는 전송 과정 중에 통신 경로상에 다음 장비의 어드레스로 교체된다.

서버 등이 보낸 이더넷 프레임이 L2 스위치에 도착하면 프레임을 받은 L2 스위치는 MAC주소를 보면서 적절한 포트에서 프레임을 꺼낸다. 하지만 다른 네트워크를 거치는 경우에는 MAC 주소를 사용한 통신이 불가능하다. 또한 IP를 이용한 브로드캐스트 주소 통신은 이더넷 상에서의 브로드캐스트 통신으로 전송된다. 

#### 8.4 VLAN

네트워크를 구축할 때는 통신이 도달하는 범위를 생각해야 한다. 특히 브로드캐스트 통신 등 전체에 데이터를 전송하는 경우는 불필요한 트래픽을 증가시키기 때문에 브로드캐스트 도메인을 고려해서 네트워크를 적절하게 분할하는 것이 필요하다. 네트워크의 범위는 스위치의 물리 구성에 의해 크게 좌우되기 때문에 이에 좌우되지 않고 설정만으로 네트워크를 나눌 수 있는 구조가 필요하다.

**VLAN 이란**

- VLAN은 물리 구성에 의존하지 않고 가상적인 네트워크를 나누는 구조다.
- 가상적으로 나눈 네트워크는 VLAN ID라 불리는 숫자로 관리한다.
- VLAN에는 몇가지 종류가 있지만 가장 자주 사용되는 것은 태그 VLAN이다. 
- 이더넷 프레임에 해당 프레임이 소속된 VLAN ID의 태그를 붙여서 하나의 물리 링크 내에서도 복수의 네트워크 프레임을 처리할 수 있는 구조이다. 
- 이를 통해 하나의 이더넷 케이블 내에서 다른 VLAN에 속하는 프레임을 전송할 수 있게 되어 물리적으로 떨어진 네트워크 스위치라도 동일 네트워크에 참가시키는 것이 가능하다.



## 9. TCP/IP 통신 이후

#### 9.1 네트워크 스위치 중계 처리

전송된 이더넷 프레임은 제일 먼저 서버와 인접하고 있는 L2스위치에 도착한다. L2는 이더넷 계층이기 때문에 이더넷 헤더에 있는 대상 MAC주소를 확인한 수 적절한 포트를 통해 프레임을 전송한다.

**L2스위치의 프레임 처리**

- 일반 서버와 달리 ASIC 회로를 사용하여 하드웨어 처리만으로도 빠르게 프레임이나 패킷을 전송할 수 있다.
- 경로 중 L3 스위치나 라우터가 있을 경우 IP 헤더를 확인하여 목적지를 결정한다.

![패킷 전송 시의 네트워크 계층](./assets/packet.png)

#### 9.2 최종 목적지의 수신 확인

- L2 스위치나 L3 스위치를 경유해서 최종 목적지인 서버에 이더넷 프레임이 도착한다. 

- NIC로 프레임이 도착하면 NIC 수신 큐에 저장하여 OS 끼어들기나 OS 폴링을 이용해서 커널 내에 프레임을 복사한다. 
- 이더넷 헤더와 푸터를 제거하고 IP패킷을 꺼낸다. 
- IP를 주소를 확인하여 자신에게 보낸 패킷이 맞는지 확인한다. 맞다면 IP 헤더를 제거하고 TCP 세그먼트를 꺼낸다. 
- TCP 포트번호를 확인하여 포트번호에 대응하는 소켓에 데이터를 전달한다.
- TCP 헤더를 제거하고 안에 있는 애플리케이션 데이터를 재구성하고 이것을 소켓을 통해 애플리케이션에 전달한다.

![](./assets/osi.png)

### References

- 그림으로 공부하는 IT 인프라 구조 - Chapter6. 시스템을 연결하는 네트워크 구조
- TCP/IP 쉽게, 더 쉽게